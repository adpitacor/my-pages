<!DOCTYPE html>
<html lang="zh-CN" data-theme="auto">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
    <title>TXTPad - Backed by TextDB</title>
    <style>
        :root {
            --bg: #ffffff;
            --fg: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --tab-bg: #f9fafb;
            --tab-active-bg: #e8f0fe;
            --accent: #2563eb;
            --btn-bg: #f3f4f6;
            --btn-fg: #111827;
            --btn-border: #d1d5db;
            --btn-hover-bg: #e5e7eb;
            --input-bg: #ffffff;
            --input-fg: #111827;
            --input-border: #d1d5db;
            --danger: #ef4444;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b0f14;
                --fg: #e5e7eb;
                --muted: #9ca3af;
                --border: #1f2937;
                --tab-bg: #0f141b;
                --tab-active-bg: #132033;
                --accent: #3b82f6;
                --btn-bg: #111827;
                --btn-fg: #e5e7eb;
                --btn-border: #374151;
                --btn-hover-bg: #1f2937;
                --input-bg: #0f141b;
                --input-fg: #e5e7eb;
                --input-border: #374151;
                --danger: #f87171;
            }
        }
        html[data-theme="light"] {
            color-scheme: light;
            --bg: #ffffff;
            --fg: #111827;
            --muted: #6b7280;
            --border: #e5e7eb;
            --tab-bg: #f9fafb;
            --tab-active-bg: #e8f0fe;
            --accent: #2563eb;
            --btn-bg: #f3f4f6;
            --btn-fg: #111827;
            --btn-border: #d1d5db;
            --btn-hover-bg: #e5e7eb;
            --input-bg: #ffffff;
            --input-fg: #111827;
            --input-border: #d1d5db;
        }
        html[data-theme="dark"] {
            color-scheme: dark;
            --bg: #0b0f14;
            --fg: #e5e7eb;
            --muted: #9ca3af;
            --border: #1f2937;
            --tab-bg: #0f141b;
            --tab-active-bg: #132033;
            --accent: #3b82f6;
            --btn-bg: #111827;
            --btn-fg: #e5e7eb;
            --btn-border: #374151;
            --btn-hover-bg: #1f2937;
            --input-bg: #0f141b;
            --input-fg: #e5e7eb;
            --input-border: #374151;
        }
        * { box-sizing: border-box; }
        body {
            margin: 0;
            font: 14px/1.5 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft Yahei", sans-serif;
            background: var(--bg);
            color: var(--fg);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            border-bottom: 1px solid var(--border);
            padding: 12px 16px;
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px 12px;
            align-items: center;
        }
        .topbar .line {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .topbar .line.actions {
            flex-wrap: wrap;
            gap: 8px;
        }
        .topbar label {
            min-width: 8.5em;
            color: var(--muted);
        }
        .topbar input[type="text"],
        .topbar input[type="password"] {
            flex: 1;
            min-width: 10rem;
            background: var(--input-bg);
            color: var(--input-fg);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            padding: 8px 10px;
            outline: none;
        }
        .topbar input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px color-mix(in oklab, var(--accent) 25%, transparent);
        }

        .btn {
            background: var(--btn-bg);
            color: var(--btn-fg);
            border: 1px solid var(--btn-border);
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background .2s ease, opacity .2s ease, color .2s ease, border-color .2s ease;
            user-select: none;
        }
        .btn:hover { background: var(--btn-hover-bg); }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .btn.danger {
            color: var(--danger);
            border-color: color-mix(in oklab, var(--danger) 50%, var(--btn-border));
        }

        #main {
            display: none;
            flex: 1 1 auto;
            min-height: 0;
            min-width: 0;
        }
        #main.show { display: flex; }

        .tabs {
            width: 240px;
            min-width: 200px;
            border-right: 1px solid var(--border);
            background: var(--bg);
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        #tabList {
            list-style: none;
            margin: 0;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            overflow: auto;
            min-height: 0;
            touch-action: pan-y;
        }
        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--tab-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            cursor: pointer;
            user-select: none;
        }
        .tab.active {
            border-color: var(--accent);
            background: var(--tab-active-bg);
        }
        .tab .title {
            flex: 1 1 auto;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        .tab .close {
            background: transparent;
            color: var(--muted);
            border: none;
            padding: 4px 6px;
            cursor: pointer;
            border-radius: 4px;
        }
        .tab .close:hover { background: var(--btn-hover-bg); }
        .add {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            border: 1px dashed var(--btn-border);
            border-radius: 6px;
            padding: 8px;
            background: transparent;
            cursor: pointer;
            color: var(--muted);
            user-select: none;
        }
        .add:hover { background: var(--btn-hover-bg); }

        .editor {
            flex: 1 1 auto;
            min-width: 0;
            min-height: 0;
            display: flex;
            flex-direction: column;
            border-left: 1px solid var(--border);
        }
        .editor textarea {
            flex: 1 1 auto;
            width: 100%;
            padding: 12px;
            border: none;
            outline: none;
            resize: none;
            background: var(--bg);
            color: var(--fg);
            font: 14px/1.6 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .editor textarea::placeholder { color: var(--muted); }
        .editor-wrap {
            position: relative;
            flex: 1 1 auto;
            display: flex;
            min-height: 0;
        }
        .tab-indicator {
            position: absolute;
            top: 10px;
            right: 14px;
            color: var(--muted);
            font-size: 12px;
            pointer-events: none;
            user-select: none;
            z-index: 1;
        }

        /* é®ç½©å±‚ */
        .mask {
            position: fixed;
            inset: 0;
            background: color-mix(in oklab, var(--bg) 85%, #000);
            backdrop-filter: blur(2px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .mask.show { display: flex; }
        .mask .box {
            background: var(--bg);
            color: var(--fg);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 16px 18px;
            box-shadow: 0 10px 30px rgba(0,0,0,.14);
            font-size: 14px;
            min-width: 180px;
            text-align: center;
        }

        @media (max-width: 768px) {
            #main.show { flex-direction: column; }
            .tabs {
                width: 100%;
                min-width: 0;
                border-right: none;
                border-bottom: 1px solid var(--border);
            }
            #tabList {
                flex-direction: row;
                gap: 6px;
                overflow-x: auto;
                overflow-y: hidden;
                padding: 8px 8px 10px;
                touch-action: pan-x;
            }
            .tab {
                min-width: 160px;
                max-width: 70vw;
            }
            .add { min-width: 100px; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sjcl/1.0.8/sjcl.min.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" crossorigin="anonymous"></script>
</head>
<body>
    <header class="topbar">
        <div class="line">
            <label for="tokenInput">æ–‡æœ¬è®°å½•åç§°ï¼š</label>
            <input id="tokenInput" type="text" placeholder="6-60ä½ï¼Œä»… 0-9 a-z A-Z - _" />
        </div>
        <div class="line">
            <label for="passwordInput">å¯†ç ï¼š</label>
            <input id="passwordInput" type="password" placeholder="å¯ç•™ç©º" />
        </div>
        <div class="line actions">
            <button id="loadBtn" class="btn">è¯»å–</button>
            <button id="saveBtn" class="btn">ä¿å­˜</button>
            <button id="sortBtn" class="btn">æ’åº</button>
            <button id="deleteBtn" class="btn danger">åˆ é™¤</button>
            <button id="exportBtn" class="btn">å¯¼å‡º</button>
            <button id="themeBtn" class="btn" title="åˆ‡æ¢ä¸»é¢˜ï¼ˆç³»ç»Ÿ/äº®/æš—ï¼‰">ğŸŒ“</button>
        </div>
    </header>

    <main id="main">
        <aside class="tabs">
            <ul id="tabList" aria-label="æ–‡æœ¬åˆ—è¡¨"></ul>
        </aside>
        <section class="editor">
            <div class="editor-wrap">
                <span id="tabIndicator" class="tab-indicator"></span>
                <textarea id="editor" placeholder="åœ¨æ­¤ç¼–è¾‘æ–‡æœ¬..."></textarea>
            </div>
        </section>
    </main>

    <div id="mask" class="mask" aria-hidden="true" aria-live="polite">
        <div class="box" id="maskText">å¤„ç†ä¸­â€¦</div>
    </div>

    <script>
        (async () => {
            // ======= State =======
            let textdbToken = "";
            let sjclPassword = "";
            let contentList = null; // ä¸ main.show åŒæ­¥ï¼šæ˜¾ç¤ºæ—¶ä¸º string[]ï¼Œéšè—æ—¶ä¸º null
            let noChange = true;
            let activeIndex = 0;

            const $ = sel => document.querySelector(sel);

            // ======= Utils =======
            const prefixErr = (msg, err) => msg + `${err?.message || err}`;
            const tryEval = f => ({
                fallback(errCb = () => {}) {
                    try { return f(); } catch (err) { return errCb(err); }
                },
                rethrow(errCb = _ => _) {
                    return this.fallback(err => { throw (errCb(err) ?? err); });
                }
            });
            const tryEvalAsync = f => ({
                async fallback(errCb = () => {}) {
                    try { return await f(); } catch (err) { return errCb(err); }
                },
                async rethrow(errCb = _ => _) {
                    return await this.fallback(err => { throw (errCb(err) ?? err); });
                }
            });

            // é®ç½©
            function showMask(text = "å¤„ç†ä¸­â€¦") {
                const mask = $("#mask");
                $("#maskText").textContent = text;
                mask.classList.add("show");
                mask.setAttribute("aria-hidden", "false");
                document.body.style.pointerEvents = "none";
                mask.style.pointerEvents = "auto";
            }
            function hideMask() {
                const mask = $("#mask");
                mask.classList.remove("show");
                mask.setAttribute("aria-hidden", "true");
                document.body.style.pointerEvents = "";
            }

            // ä¸‹è½½
            function downloadBlob(filename, blob) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                URL.revokeObjectURL(url);
            }

            // æ–‡ä»¶åæ¸…ç†ï¼šæ›¿æ¢ä¸å…è®¸å­—ç¬¦ï¼Œä¸å¤„ç†å°¾éƒ¨ç‚¹/ç©ºæ ¼ï¼Œä¸å‹ç¼©è¿ç»­ä¸‹åˆ’çº¿
            function sanitizeFileName(name) {
                const invalid = /[-\u001F\\/:*?"<>|]/g;
                return String(name).replace(invalid, "_");
            }

            // ======= Crypto =======
            const encrypt = text => (
                sjcl.encrypt(sjclPassword, text, {
                    ks: 256, iter: 200000, mode: 'ccm', ts: 128
                })
            );
            const decrypt = cipher => sjcl.decrypt(sjclPassword, cipher);

            // ======= TextDB è°ƒç”¨ =======
            const callAPI = param => tryEvalAsync(() => (
                (param == undefined
                    ? fetch(new URL(textdbToken, callAPI._base))
                    : fetch(new URL("update", callAPI._base), {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: new URLSearchParams({ key: textdbToken, value: param })
                    })
                ).then(_ => _.text())
            )).rethrow(
                err => new Error(prefixErr("è°ƒç”¨TextDB APIå¤±è´¥", err))
            );
            callAPI._base = "https://textdb.online";

            const validateToken = () => {
                if (!/^[0-9A-Za-z-_]{6,60}$/.test(textdbToken)) {
                    throw new Error("æ–‡æœ¬è®°å½•åç§°ä¸ç¬¦åˆ/^[0-9A-Za-z-_]{6,60}$/ï¼Œè¯·é‡æ–°è®¾ç½®");
                }
            };

            const readRecord = () => tryEvalAsync(async () => {
                validateToken();
                const cipher = await callAPI();
                if (!cipher) return [""];
                try {
                    const decrypted = tryEval(() => decrypt(cipher))
                        .rethrow(err =>
                            "è§£å¯†å¤±è´¥ï¼Œå¯èƒ½æ˜¯å¯†æ–‡å·²æŸåã€å¯†ç é”™è¯¯ï¼Œæˆ–è®°å½•ä¸ç¬¦åˆåŠ å¯†æ ¼å¼ã€‚\n" +
                            prefixErr("å…·ä½“é”™è¯¯ä¿¡æ¯ï¼š", err)
                        );
                    const records = tryEval(() => JSON.parse(decrypted))
                        .rethrow(_ => "æ–‡æœ¬è®°å½•æ— æ³•ä½œä¸ºJSONè§£æã€‚");
                    const isOldFormat = x => (
                        typeof x == 'object' &&
                        x != null &&
                        Object.entries(x).length == 2 &&
                        typeof x?.title == 'string' &&
                        typeof x?.content == 'string'
                    );
                    if (Array.isArray(records)) {
                        if (records.every(isOldFormat)) return records.map(x => x.content);
                        else if (records.every(x => typeof x == 'string')) return [...records];
                    }
                    throw "æ–‡æœ¬è®°å½•JSONä¸ºæœªè¯†åˆ«çš„ç»“æ„ã€‚";
                } catch (msg) {
                    const flag = confirm(msg + "\næ˜¯å¦ä»¥æ˜æ–‡å½¢å¼æ˜¾ç¤ºæ–‡æœ¬è®°å½•ï¼Ÿ");
                    if (flag) return [cipher];
                    else throw new Error("æ— æ³•è§£ææ–‡æœ¬è®°å½•");
                }
            }).fallback(
                err => (alert(`è¯»å–å¤±è´¥ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n${err}`), null)
            );

            const saveRecord = data => tryEvalAsync(async () => {
                validateToken();
                if (data) data = encrypt(data);
                const resp = await callAPI(data);
                const res = tryEval(() => JSON.parse(resp)).rethrow(
                    _ => new Error("APIè¿”å›å€¼æ— æ³•ä½œä¸ºJSONè§£æ")
                );
                if (res.status != 1) throw res?.error || res?.reason || res?.message || resp;
                return true;
            }).fallback(
                err => (alert((data ? "ä¿å­˜" : "åˆ é™¤") + `å¤±è´¥ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n${err}`), false)
            );

            // ======= UI æ§åˆ¶ =======
            const mainEl = $("#main");
            const tabListEl = $("#tabList");
            const editorEl = $("#editor");
            const themeBtn = $("#themeBtn");
            const tabIndicatorEl = $("#tabIndicator");

            const hideBrowser = () => {
                mainEl.classList.remove("show");
                editorEl.value = "";
                contentList = null; // åŒæ­¥åˆ°â€œæ— æ­£åœ¨æ˜¾ç¤ºçš„æ–‡æœ¬è®°å½•â€
                activeIndex = 0;
                tabIndicatorEl.textContent = "";
                updateActionButtons();
            };
            const showBrowser = () => {
                mainEl.classList.add("show");
                if (!Array.isArray(contentList) || contentList.length === 0) {
                    contentList = [""];
                }
                selectTab(Math.min(Math.max(0, activeIndex), contentList.length - 1));
                updateActionButtons();
            };

            const genTitle = cont => {
                for (const line of String(cont).split('\n')) {
                    const lineTrimmed = line.trim();
                    if (lineTrimmed) return lineTrimmed.substr(0, genTitle._maxLen);
                }
                return "æ–°æ–‡æœ¬";
            };
            genTitle._maxLen = 24;

            const clearTabs = () => {
                while (tabListEl.firstChild) tabListEl.removeChild(tabListEl.firstChild);
                const addLi = document.createElement("li");
                addLi.className = "add";
                addLi.setAttribute("role", "button");
                addLi.innerHTML = "<span>ï¼‹ æ–°å¢</span>";
                addLi.addEventListener("click", () => {
                    if (!Array.isArray(contentList)) contentList = [];
                    contentList.push("");
                    noChange = false;
                    rebuildTabs();
                    selectTab(contentList.length - 1, true);
                });
                tabListEl.appendChild(addLi);
            };

            const addTab = (cont = "", idx = null) => {
                const index = idx ?? tabCount();
                const li = document.createElement("li");
                li.className = "tab";
                li.dataset.index = String(index);
                li.innerHTML = `
                    <span class="title"></span>
                    <button class="close" title="å…³é—­">Ã—</button>
                `;

                const titleEl = li.querySelector(".title");
                titleEl.textContent = genTitle(cont);

                li.addEventListener("click", e => {
                    if (e.target.closest(".close")) return;
                    selectTab(Number(li.dataset.index), true);
                });

                li.querySelector(".close").addEventListener("click", e => {
                    e.stopPropagation();
                    if (contentList.length <= 1) {
                        alert("è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªæ–‡æœ¬");
                        return;
                    }
                    if (!confirm("ç¡®è®¤å…³é—­è¯¥æ ‡ç­¾é¡µï¼Ÿ")) return;
                    const toRemove = Number(li.dataset.index);
                    contentList.splice(toRemove, 1);
                    noChange = false;
                    const nextIdx = Math.min(toRemove, contentList.length - 1);
                    rebuildTabs();
                    selectTab(nextIdx, true);
                });

                tabListEl.insertBefore(li, tabListEl.lastElementChild);
            };

            const tabCount = () => tabListEl.querySelectorAll(".tab").length;

            const rebuildTabs = () => {
                const current = Math.min(Math.max(0, activeIndex), (contentList?.length || 1) - 1);
                clearTabs();
                (contentList || [""]).forEach((cont, i) => addTab(cont, i));
                refreshTabIndices();
                selectTab(current);
            };

            const refreshTabIndices = () => {
                const tabs = tabListEl.querySelectorAll(".tab");
                tabs.forEach((li, i) => { li.dataset.index = String(i); });
            };

            const selectTab = (i, focusEditor = false) => {
                if (!Array.isArray(contentList) || !contentList.length) return;
                const tabs = tabListEl.querySelectorAll(".tab");
                tabs.forEach(t => t.classList.remove("active"));
                const target = tabs[i];
                if (!target) return;
                target.classList.add("active");
                activeIndex = i;
                editorEl.value = contentList[i] ?? "";
                updateTabIndicator();
                if (focusEditor) editorEl.focus();
            };

            editorEl.addEventListener("input", () => {
                if (!Array.isArray(contentList) || contentList.length === 0) return;
                contentList[activeIndex] = editorEl.value;
                const currentTab = tabListEl.querySelector(`.tab[data-index="${activeIndex}"] .title`);
                if (currentTab) currentTab.textContent = genTitle(editorEl.value);
                noChange = false;
            });

            function updateActionButtons() {
                const hasVisible = mainEl.classList.contains("show") && Array.isArray(contentList);
                $("#saveBtn").disabled = !hasVisible;
                $("#sortBtn").disabled = !hasVisible;
                $("#deleteBtn").disabled = !hasVisible;
                $("#exportBtn").disabled = !hasVisible;
            }

            function updateTabIndicator() {
                if (Array.isArray(contentList) && contentList.length > 0) {
                    tabIndicatorEl.textContent = `æ ‡ç­¾é¡µ ${activeIndex + 1}`;
                } else {
                    tabIndicatorEl.textContent = "";
                }
            }

            const updateBrowser = () => {
                clearTabs();
                for (const cont of contentList) addTab(cont);
                showBrowser();
            };

            const resetBrowser = () => {
                noChange = true;
                hideBrowser();
                clearTabs();
                // contentList å·²åœ¨ hideBrowser ç½®ä¸º null
                activeIndex = 0;
            };

            // ======= ä¸»é¢˜åˆ‡æ¢ï¼ˆç³»ç»Ÿ/äº®/æš—ï¼‰ =======
            const themeModes = ["auto", "light", "dark"];
            const themeEmojis = { auto: "ğŸŒ“", light: "â˜€ï¸", dark: "ğŸŒ™" };
            function applyTheme(mode) {
                document.documentElement.setAttribute("data-theme", mode);
                themeBtn.textContent = themeEmojis[mode] || "ğŸŒ“";
                localStorage.setItem("themeMode", mode);
            }
            (function initTheme() {
                const saved = localStorage.getItem("themeMode") || "auto";
                applyTheme(saved);
                themeBtn.addEventListener("click", () => {
                    const cur = document.documentElement.getAttribute("data-theme") || "auto";
                    const next = themeModes[(themeModes.indexOf(cur) + 1) % themeModes.length];
                    applyTheme(next);
                });
            })();

            // ======= å…³é—­/åˆ·æ–°æ‹¦æˆª =======
            window.addEventListener("beforeunload", (e) => {
                if (!noChange) {
                    e.preventDefault();
                    e.returnValue = "";
                }
            });

            // ======= é¡¶æ ç»‘å®š =======
            tryEval(function init() {
                hideBrowser();

                const syncInputsToState = () => {
                    const tokenVal = $("#tokenInput").value.trim();
                    const passVal = $("#passwordInput").value;
                    textdbToken = tokenVal;
                    sjclPassword = passVal;
                };

                $("#loadBtn").addEventListener("click", async () => {
                    syncInputsToState();
                    if (Array.isArray(contentList) && !noChange) {
                        const ok = confirm("è¯»å–å°†ä¼šè¦†ç›–æœªä¿å­˜çš„ä¿®æ”¹ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ");
                        if (!ok) return;
                    }
                    showMask("è¯»å–ä¸­â€¦");
                    const result = await readRecord();
                    hideMask();
                    if (result == null) {
                        hideBrowser();
                        return;
                    }
                    contentList = result;
                    noChange = true;
                    activeIndex = 0; // è¯»å–åé‡ç½®é€‰æ‹©åˆ°ç¬¬ä¸€ä¸ª
                    updateBrowser();
                    alert("è¯»å–æˆåŠŸ");
                    if (Array.isArray(contentList) && contentList.length === 1 && contentList[0] === "") {
                        alert("æ–‡æœ¬æ˜¯ç©ºçš„ï¼Œå¯ä»¥ä½¿ç”¨â€¦");
                    }
                });

                $("#saveBtn").addEventListener("click", async () => {
                    syncInputsToState();
                    if (!Array.isArray(contentList)) {
                        alert("æš‚æ— å¯ä¿å­˜å†…å®¹ï¼Œè¯·å…ˆè¯»å–æˆ–æ–°å¢");
                        return;
                    }
                    showMask("ä¿å­˜ä¸­â€¦");
                    const ok = await saveRecord(JSON.stringify(contentList));
                    hideMask();
                    if (ok) {
                        noChange = true;
                        alert("ä¿å­˜æˆåŠŸ");
                    }
                });

                $("#sortBtn").addEventListener("click", () => {
                    if (!Array.isArray(contentList) || contentList.length < 2) {
                        alert("è‡³å°‘éœ€è¦ä¸¤ä¸ªæ ‡ç­¾é¡µæ‰èƒ½æ’åº");
                        return;
                    }

                    const currentNum = activeIndex + 1;
                    const currentTitle = genTitle(contentList[activeIndex]);
                    const maxNum = contentList.length;

                    const input = prompt(
                        `å°†å½“å‰ã€Œæ ‡ç­¾é¡µ ${currentNum}: ${currentTitle}ã€ç§»åŠ¨åˆ°å“ªä¸ªä½ç½®ä¹‹åï¼Ÿ\n\n` +
                        `è¾“å…¥ 0 = ç§»åˆ°å¼€å¤´\n` +
                        `è¾“å…¥ 1~${maxNum} = ç§»åˆ°æŒ‡å®šæ ‡ç­¾é¡µä¹‹å\n` +
                        `ï¼ˆå½“å‰å…± ${maxNum} ä¸ªæ ‡ç­¾é¡µï¼‰`
                    );

                    if (input === null) return; // ç”¨æˆ·å–æ¶ˆ

                    const targetPos = parseInt(input.trim(), 10);
                    if (isNaN(targetPos) || targetPos < 0 || targetPos > maxNum) {
                        alert(`è¯·è¾“å…¥ 0 åˆ° ${maxNum} ä¹‹é—´çš„æ•°å­—`);
                        return;
                    }

                    // è®¡ç®—æ–°çš„ç´¢å¼•ä½ç½®
                    // targetPos=0 è¡¨ç¤ºæ’å…¥åˆ°å¼€å¤´ï¼Œå³æ–°ç´¢å¼•ä¸º 0
                    // targetPos=n è¡¨ç¤ºæ’å…¥åˆ°ç¬¬ n ä¸ªä¹‹åï¼Œå³æ–°ç´¢å¼•ä¸º nï¼ˆä½†è¦è€ƒè™‘ç§»é™¤è‡ªèº«çš„å½±å“ï¼‰
                    const fromIndex = activeIndex;
                    let toIndex = targetPos; // ç›®æ ‡ä½ç½®ï¼ˆæ’å…¥åˆ° targetPos ä¹‹åï¼‰

                    // å¦‚æœç›®æ ‡ä½ç½®å°±æ˜¯å½“å‰ä½ç½®æˆ–å½“å‰ä½ç½®çš„å‰ä¸€ä¸ªï¼Œåˆ™æ— éœ€ç§»åŠ¨
                    if (toIndex === fromIndex || toIndex === fromIndex + 1) {
                        alert("æ ‡ç­¾é¡µä½ç½®æœªæ”¹å˜");
                        return;
                    }

                    // ä»æ•°ç»„ä¸­å–å‡ºå½“å‰å†…å®¹
                    const [movedContent] = contentList.splice(fromIndex, 1);

                    // å¦‚æœåŸä½ç½®åœ¨ç›®æ ‡ä½ç½®ä¹‹å‰ï¼Œå–å‡ºåç›®æ ‡ç´¢å¼•éœ€è¦å‡ 1
                    if (fromIndex < toIndex) {
                        toIndex -= 1;
                    }

                    // æ’å…¥åˆ°æ–°ä½ç½®
                    contentList.splice(toIndex, 0, movedContent);

                    // æ›´æ–° activeIndex ä¸ºæ–°ä½ç½®
                    activeIndex = toIndex;
                    noChange = false;

                    // é‡å»ºæ ‡ç­¾é¡µå¹¶é€‰ä¸­
                    rebuildTabs();
                    selectTab(activeIndex, true);

                    alert(`å·²ç§»åŠ¨åˆ°æ ‡ç­¾é¡µ ${activeIndex + 1}`);
                });

                $("#deleteBtn").addEventListener("click", async () => {
                    syncInputsToState();
                    if (!Array.isArray(contentList)) return;
                    const okConfirm = confirm("åˆ é™¤åæ•°æ®å°†æ— æ³•æ‰¾å›ï¼Œç¡®è®¤ç»§ç»­ï¼Ÿ");
                    if (!okConfirm) return;
                    showMask("åˆ é™¤ä¸­â€¦");
                    const ok = await saveRecord("");
                    hideMask();
                    if (ok) {
                        alert("æ–‡æœ¬å·²åˆ é™¤");
                        resetBrowser(); // æç¤ºåå†éšè—ä¸»ä½“
                    }
                });

                $("#exportBtn").addEventListener("click", async () => {
                    syncInputsToState();
                    if (!Array.isArray(contentList)) return;

                    // ç¡®è®¤ï¼šé€ä¸ªå¯¼å‡ºä¸º .txt -> .zipï¼›å–æ¶ˆï¼šåˆå¹¶å¯¼å‡ºä¸º JSON
                    const doZip = confirm("ç‚¹å‡»â€œç¡®è®¤â€ï¼šé€ä¸ªå¯¼å‡ºä¸º .txt å¹¶æ‰“åŒ…ä¸º .zipï¼›ç‚¹å‡»â€œå–æ¶ˆâ€ï¼šåˆå¹¶å¯¼å‡ºä¸º JSONã€‚");

                    showMask("å¯¼å‡ºä¸­â€¦");
                    try {
                        const baseName = sanitizeFileName(textdbToken || "TXTPad");

                        if (doZip) {
                            const zip = new JSZip();
                            (contentList || []).forEach((text, idx) => {
                                const title = genTitle(text);
                                const safeTitle = sanitizeFileName(title) || "æœªå‘½å";
                                const filename = `${idx + 1}-${safeTitle}.txt`; // ä»1å¼€å§‹ç¼–å·
                                zip.file(filename, text ?? "");
                            });
                            const blob = await zip.generateAsync({ type: "blob" });
                            downloadBlob(`${baseName}.zip`, blob);
                        } else {
                            const blob = new Blob([JSON.stringify(contentList, null, 2)], { type: "application/json" });
                            downloadBlob(`${baseName}.json`, blob);
                        }

                        hideMask();
                        alert("å¯¼å‡ºæˆåŠŸ");
                    } catch (err) {
                        hideMask();
                        alert(`å¯¼å‡ºå¤±è´¥ï¼ŒåŸå› å¦‚ä¸‹ï¼š\n${err?.message || err}`);
                    }
                });

                // æ–‡æœ¬è®°å½•åç§°å˜æ›´ï¼šå½“å­˜åœ¨â€œæ­£åœ¨æ˜¾ç¤ºçš„æ–‡æœ¬è®°å½•â€æ—¶æ‰å¼¹å‡ºç¡®è®¤
                $("#tokenInput").addEventListener("change", e => {
                    const newToken = e.target.value.trim();
                    if (newToken === textdbToken) return;

                    const hasVisible = mainEl.classList.contains("show") && Array.isArray(contentList);
                    if (hasVisible) {
                        if (!confirm("ä½ è®¾ç½®äº†æ–°çš„æ–‡æœ¬è®°å½•åç§°ï¼Œå°†æ”¾å¼ƒå½“å‰æ­£åœ¨æ˜¾ç¤ºçš„æ–‡æœ¬ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) {
                            e.target.value = textdbToken ?? "";
                            return;
                        }
                        textdbToken = newToken;
                        resetBrowser();
                    } else {
                        textdbToken = newToken;
                    }
                });

                $("#passwordInput").addEventListener("change", e => {
                    sjclPassword = e.target.value;
                });

                // åˆå§‹æ„å»ºç©ºåˆ—è¡¨ï¼ˆéšè—çŠ¶æ€ï¼‰
                clearTabs();
            }).fallback(
                err => { alert(`åˆå§‹åŒ–å¤±è´¥ï¼š\n${err}`); }
            );
        })();
    </script>
</body>
</html>
